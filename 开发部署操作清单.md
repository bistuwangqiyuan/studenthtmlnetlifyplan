# 学生信息管理系统 - 完整开发部署操作清单

## 一、项目背景与需求

### 1.1 项目需求
- 开发一个学生信息管理系统Web程序
- 实现对学生、课程、教师信息的增删改查功能
- 管理员登录/注册功能
- 部署在 Netlify，使用 Neon PostgreSQL 数据库
- 系统正确处理中文，不出现乱码
- 人性化的用户界面设计

### 1.2 技术栈选择
- **前端**: 纯 HTML/CSS/JavaScript（无框架）
- **后端**: Netlify Functions（Serverless）
- **数据库**: Neon PostgreSQL
- **部署平台**: Netlify
- **认证方式**: JWT (JSON Web Token)
- **密码加密**: bcrypt

---

## 二、前期准备工作

### 2.1 环境准备
1. **安装 Node.js 和 npm**
   - 确保已安装 Node.js 14+ 版本
   - 验证：`node --version` 和 `npm --version`

2. **安装 Netlify CLI**
   ```bash
   npm install -g netlify-cli
   ```

3. **登录 Netlify**
   ```bash
   netlify login
   ```
   - 浏览器会打开，完成授权

### 2.2 Neon 数据库准备
1. 访问 [Neon Console](https://console.neon.tech/)
2. 创建新项目或使用现有项目
3. 获取两个连接字符串：
   - **池化连接**: `NETLIFY_DATABASE_URL`
   - **非池化连接**: `NETLIFY_DATABASE_URL_UNPOOLED`
4. 记录连接字符串格式类似：
   ```
   postgresql://用户名:密码@主机/数据库?sslmode=require
   ```

### 2.3 Netlify 项目配置
1. 在 Netlify Dashboard 创建新站点或使用现有站点
2. 记录站点 ID（例如：`e3b7caaa-754b-4a1d-a6fb-618dbc3b5f3b`）
3. 本地项目关联站点：
   ```bash
   netlify link
   ```
   - 选择对应的站点

---

## 三、项目文件结构创建

### 3.1 初始化项目
```bash
mkdir studenthtmlnetlifyplan
cd studenthtmlnetlifyplan
npm init -y
```

### 3.2 安装依赖
```bash
npm install bcryptjs jsonwebtoken pg
```

**package.json 最终内容：**
```json
{
  "name": "student-info-system",
  "version": "1.0.0",
  "description": "学生信息管理系统 - 静态前端 + Netlify Functions + Neon 数据库",
  "scripts": {
    "dev": "netlify dev",
    "lint": "echo \"No linting configured\"",
    "start": "netlify dev"
  },
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "pg": "^8.12.0"
  }
}
```

### 3.3 创建目录结构
```
studenthtmlnetlifyplan/
├── index.html              # 单页应用入口
├── styles.css              # 全局样式
├── app.js                  # 前端交互逻辑
├── package.json            # 依赖配置
├── netlify.toml            # Netlify 配置
├── README.md               # 项目说明
└── netlify/
    └── functions/          # Netlify Functions
        ├── _shared/        # 共享模块
        │   ├── auth.js
        │   ├── http.js
        │   └── validators.js
        ├── db.js
        ├── init-db.js
        ├── auth-login.js
        ├── auth-register.js
        ├── students-id.js
        ├── courses-id.js
        └── teachers-id.js
```

---

## 四、前端文件开发

### 4.1 index.html
创建完整的 HTML 结构，包含：
- 登录/注册表单切换
- 管理界面（学生/课程/教师管理）
- 数据表格
- 弹窗对话框（用于新增/编辑）

**关键点：**
- `<meta charset="UTF-8">` 确保中文支持
- `lang="zh-CN"` 设置语言
- 使用语义化 HTML5 标签
- 表单使用 `autocomplete` 属性
- 弹窗使用原生 `<dialog>` 元素

### 4.2 styles.css
设计响应式样式：
- 使用 CSS 自定义属性（`:root`）
- 移动优先设计（`@media` 断点 640px）
- 中文字体栈：`'Inter', 'PingFang SC', 'Microsoft YaHei'`
- 现代 UI：圆角、阴影、渐变
- 表格横向滚动支持

### 4.3 app.js
前端逻辑实现：
- 状态管理（`state` 对象）
- API 请求封装（`apiRequest` 函数）
- 登录/注册流程
- JWT 令牌存储（localStorage）
- 动态表格渲染
- 表单验证
- 增删改查操作

**API 调用路径：**
```javascript
const API_BASE = "/.netlify/functions";
```

---

## 五、后端 Functions 开发

### 5.1 共享模块 (_shared/)

#### 5.1.1 http.js - HTTP 响应辅助函数
```javascript
// 包含的函数：
- mergeHeaders()       // 合并默认 CORS 头
- json()               // JSON 响应
- success()            // 200 成功
- created()            // 201 创建成功
- noContent()          // 204 无内容
- badRequest()         // 400 错误请求
- unauthorized()       // 401 未授权
- forbidden()          // 403 禁止
- notFound()           // 404 未找到
- serverError()        // 500 服务器错误
- methodNotAllowed()   // 405 方法不允许
- options()            // OPTIONS 请求
```

**关键配置：**
- `charset=utf-8` 确保中文正确返回
- CORS 头：`Access-Control-Allow-Origin: *`

#### 5.1.2 auth.js - 认证辅助函数
```javascript
// 包含的函数：
- signToken()          // 签发 JWT
- verifyToken()        // 验证 JWT
- hashPassword()       // 密码哈希（bcrypt）
- comparePassword()    // 密码比对
- withAuth()           // 认证中间件（高阶函数）
```

**环境变量要求：**
- `JWT_SECRET`: JWT 签名密钥
- `JWT_EXPIRES_IN`: 令牌过期时间（默认 12h）

#### 5.1.3 validators.js - 数据验证函数
```javascript
// 包含的函数：
- normalizeString()    // 字符串规范化
- normalizeNumber()    // 数字规范化
- validateStudent()    // 学生数据验证
- validateCourse()     // 课程数据验证
- validateTeacher()    // 教师数据验证
```

### 5.2 数据库模块

#### 5.2.1 db.js - 数据库连接管理
```javascript
// 核心功能：
- getPool()            // 获取连接池
- query()              // 执行 SQL 查询
- withTransaction()    // 事务包装器
```

**连接配置：**
```javascript
{
  connectionString: process.env.NETLIFY_DATABASE_URL,
  ssl: { rejectUnauthorized: false },
  max: 4,
  idleTimeoutMillis: 10000
}
```

#### 5.2.2 init-db.js - 数据库初始化
**功能：**
1. 删除旧表（students, courses, teachers）
2. 创建新表结构
3. 创建触发器（自动更新 updated_at）
4. 插入默认管理员账号

**数据表结构：**

**admins 表：**
```sql
CREATE TABLE IF NOT EXISTS admins (
  id SERIAL PRIMARY KEY,
  username VARCHAR(64) UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**students 表：**
```sql
CREATE TABLE students (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  gender VARCHAR(10),
  age INTEGER CHECK (age IS NULL OR age >= 0),
  class_name VARCHAR(120),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**courses 表：**
```sql
CREATE TABLE courses (
  id SERIAL PRIMARY KEY,
  name VARCHAR(150) NOT NULL,
  code VARCHAR(50) UNIQUE NOT NULL,
  credit NUMERIC(5,2),
  teacher VARCHAR(120),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**teachers 表：**
```sql
CREATE TABLE teachers (
  id SERIAL PRIMARY KEY,
  name VARCHAR(120) NOT NULL,
  title VARCHAR(120),
  phone VARCHAR(40),
  email VARCHAR(160),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**默认管理员：**
- 用户名：`admin`
- 密码：`admin`

### 5.3 认证 Functions

#### 5.3.1 auth-login.js
- 验证用户名密码
- 查询 admins 表
- bcrypt 比对密码
- 颁发 JWT 令牌

#### 5.3.2 auth-register.js
- 验证用户名长度（≥3）
- 验证密码长度（≥6）
- 检查用户名重复
- bcrypt 加密密码
- 插入新管理员
- 自动颁发令牌

### 5.4 资源 CRUD Functions

#### 5.4.1 学生管理
**students/index.js**（已删除，改为扁平结构）
- GET: 列表查询（支持搜索）
- POST: 创建学生

**students-id.js**（新建）
- GET: 查询单个学生
- PUT: 更新学生
- DELETE: 删除学生

**parseId 逻辑：**
```javascript
function parseId(event) {
  let id = event.queryStringParameters?.id || 
           event.pathParameters?.id || 
           event.path.match(/\/students[/-](?:id\/)?(\d+)/)?.[1];
  
  if (!id) return null;
  const numeric = Number(id);
  if (!Number.isInteger(numeric) || numeric <= 0) return null;
  return numeric;
}
```

#### 5.4.2 课程管理
**courses-id.js**
- 与 students-id 结构相同
- 额外处理课程编号唯一性（23505 错误码）

#### 5.4.3 教师管理
**teachers-id.js**
- 与 students-id 结构相同
- 支持邮箱验证

---

## 六、Netlify 配置

### 6.1 netlify.toml
```toml
[build]
  command = "npm install"
  publish = "."

[functions]
  directory = "netlify/functions"
  node_bundler = "esbuild"

[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200

[[redirects]]
  from = "/.netlify/functions/students/:id"
  to = "/.netlify/functions/students-id?id=:id"
  status = 200

[[redirects]]
  from = "/.netlify/functions/courses/:id"
  to = "/.netlify/functions/courses-id?id=:id"
  status = 200

[[redirects]]
  from = "/.netlify/functions/teachers/:id"
  to = "/.netlify/functions/teachers-id?id=:id"
  status = 200
```

**注意：** 
- 重定向规则中 `from` 路径不能以 `/.netlify` 开头会有警告，但仍能工作
- 使用查询参数传递 ID

### 6.2 环境变量配置

在 Netlify Dashboard 或通过 CLI 设置：

```bash
netlify env:set NETLIFY_DATABASE_URL "postgresql://用户:密码@主机/数据库?sslmode=require"
netlify env:set NETLIFY_DATABASE_URL_UNPOOLED "postgresql://用户:密码@主机/数据库?sslmode=require"
netlify env:set JWT_SECRET "a8f5e2c9d1b7468f3e0a9c5d2f8b1e4a7c3d6f9e2b5a8c1d4e7f0a3b6c9d2e5f8"
```

**JWT_SECRET 生成方法：**
```bash
openssl rand -hex 32
```

或使用在线生成器生成 64 位十六进制字符串。

---

## 七、部署流程

### 7.1 首次部署
```bash
cd studenthtmlnetlifyplan
netlify deploy --prod
```

**部署过程：**
1. Netlify Build 执行 `npm install`
2. Functions 打包（esbuild）
3. 上传静态文件和 Functions
4. 生成唯一部署 URL
5. 更新生产环境 URL

### 7.2 数据库初始化
**首次部署后必须执行一次：**

```powershell
Invoke-WebRequest -Uri "https://studenthtmlnetlifyplan.netlify.app/.netlify/functions/init-db" -Method POST
```

或使用 curl（Linux/Mac）：
```bash
curl -X POST https://studenthtmlnetlifyplan.netlify.app/.netlify/functions/init-db
```

**返回结果：**
```json
{
  "message": "数据库初始化完成",
  "defaultAdmin": {
    "username": "admin",
    "password": "admin"
  }
}
```

### 7.3 后续部署
每次代码修改后：
```bash
netlify deploy --prod
```

---

## 八、遇到的问题及解决方案

### 8.1 问题1：登录返回 502 错误
**原因：** 缺少 `JWT_SECRET` 环境变量

**解决：**
```bash
netlify env:set JWT_SECRET "生成的随机字符串"
netlify deploy --prod
```

### 8.2 问题2：新增学生报错 "student_number 字段不能为空"
**原因：** 数据库中存在旧的表结构，`CREATE TABLE IF NOT EXISTS` 不会修改已存在的表

**解决方案：**
修改 `init-db.js`，添加 DROP TABLE 语句：
```javascript
const dropStatements = [
  `DROP TABLE IF EXISTS students CASCADE;`,
  `DROP TABLE IF EXISTS courses CASCADE;`,
  `DROP TABLE IF EXISTS teachers CASCADE;`,
];

// 在事务中先执行 DROP，再 CREATE
for (const statement of dropStatements) {
  await client.query(statement);
}
```

重新部署并初始化数据库。

### 8.3 问题3：编辑/删除功能返回 "Method Not Allowed"
**原因：** Netlify Functions 不支持嵌套文件夹中的动态路由 `[id].js`

**解决方案：**
1. 将 `students/[id].js` 重命名为 `students-id.js`
2. 将 `courses/[id].js` 重命名为 `courses-id.js`
3. 将 `teachers/[id].js` 重命名为 `teachers-id.js`
4. 在 `netlify.toml` 中配置重定向规则
5. 修改 `parseId` 函数支持查询参数

### 8.4 问题4：中文乱码
**解决方案：**
- HTML: `<meta charset="UTF-8">`
- HTTP 响应: `Content-Type: application/json; charset=utf-8`
- 数据库连接: PostgreSQL 默认使用 UTF-8
- Neon 连接字符串中无需额外配置

---

## 九、测试验证清单

### 9.1 登录/注册测试
- [ ] 使用默认管理员登录（admin/admin）✅
- [ ] 注册新管理员账号✅
- [ ] 密码不一致提示✅
- [ ] 用户名已存在提示✅
- [ ] 登录后显示管理界面✅
- [ ] 退出登录功能✅

### 9.2 学生管理测试
- [ ] 查看学生列表✅
- [ ] 搜索学生（按姓名/班级）
- [ ] 新增学生（含中文）✅
- [ ] 编辑学生信息
- [ ] 删除学生
- [ ] 必填字段验证
- [ ] 年龄范围验证（0-120）

### 9.3 课程管理测试
- [ ] 查看课程列表
- [ ] 搜索课程（按课程名/编号/教师）
- [ ] 新增课程
- [ ] 编辑课程
- [ ] 删除课程
- [ ] 课程编号唯一性验证
- [ ] 学分范围验证（0-60）

### 9.4 教师管理测试
- [ ] 查看教师列表
- [ ] 搜索教师
- [ ] 新增教师
- [ ] 编辑教师
- [ ] 删除教师
- [ ] 邮箱格式验证
- [ ] 电话格式验证

### 9.5 UI/UX 测试
- [ ] 移动端响应式布局
- [ ] 表格横向滚动
- [ ] 成功/错误提示显示
- [ ] 确认删除对话框
- [ ] 表单验证提示
- [ ] 中文显示正常无乱码

---

## 十、本地开发调试

### 10.1 配置本地环境变量
创建 `.env` 文件（不要提交到 Git）：
```env
NETLIFY_DATABASE_URL=postgresql://...
NETLIFY_DATABASE_URL_UNPOOLED=postgresql://...
JWT_SECRET=your_jwt_secret_here
JWT_EXPIRES_IN=12h
```

### 10.2 启动本地开发服务器
```bash
netlify dev
```

访问 `http://localhost:8888`

### 10.3 本地测试 Functions
```bash
# 测试初始化
curl -X POST http://localhost:8888/.netlify/functions/init-db

# 测试登录
curl -X POST http://localhost:8888/.netlify/functions/auth-login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin"}'
```

---

## 十一、代码版本控制

### 11.1 Git 忽略文件 (.gitignore)
```
node_modules/
.env
.netlify/
*.log
.DS_Store
.playwright-mcp/
```

### 11.2 提交建议
```bash
git init
git add .
git commit -m "Initial commit: Student Management System"
git branch -M main
git remote add origin https://github.com/your-username/your-repo.git
git push -u origin main
```

---

## 十二、生产环境维护

### 12.1 监控检查
- Netlify Dashboard → Functions → Logs
- 查看函数调用次数、错误率
- 查看部署历史

### 12.2 数据库维护
- 定期备份 Neon 数据库
- 监控连接数
- 检查查询性能

### 12.3 安全建议
1. **JWT_SECRET** 定期更换（会使现有令牌失效）
2. 考虑添加 **请求频率限制**
3. 考虑 **CORS 白名单** 而非 `*`
4. 考虑 **管理员审核机制**

---

## 十三、扩展功能建议

### 13.1 可选增强
- [ ] 分页功能（当前一次性加载全部）
- [ ] 排序功能（按字段升序/降序）
- [ ] 批量操作（批量删除）
- [ ] 数据导出（CSV/Excel）
- [ ] 头像上传
- [ ] 权限分级（超级管理员/普通管理员）
- [ ] 操作日志记录
- [ ] 邮箱验证码登录
- [ ] 密码找回功能

### 13.2 性能优化
- [ ] 前端虚拟滚动（大数据量）
- [ ] 服务端分页
- [ ] Redis 缓存热点数据
- [ ] CDN 加速静态资源

---

## 十四、关键命令速查表

```bash
# 安装依赖
npm install

# 本地开发
netlify dev

# 部署到生产环境
netlify deploy --prod

# 查看环境变量
netlify env:list

# 设置环境变量
netlify env:set KEY "VALUE"

# 查看站点状态
netlify status

# 查看函数列表
netlify functions:list

# 查看部署日志
netlify open:admin
```

---

## 十五、联系人与资源

### 15.1 项目信息
- **项目名称**: studenthtmlnetlifyplan
- **站点ID**: e3b7caaa-754b-4a1d-a6fb-618dbc3b5f3b
- **生产URL**: https://studenthtmlnetlifyplan.netlify.app
- **管理员账号**: admin / admin

### 15.2 相关文档
- [Netlify Functions 文档](https://docs.netlify.com/functions/overview/)
- [Neon PostgreSQL 文档](https://neon.tech/docs/introduction)
- [JWT 规范](https://jwt.io/)
- [bcrypt 文档](https://github.com/kelektiv/node.bcrypt.js)

---

## 十六、完整文件清单

### 静态资源文件
- ✅ index.html (113 行)
- ✅ styles.css (313 行)
- ✅ app.js (451 行)
- ✅ README.md (108 行)

### 配置文件
- ✅ package.json
- ✅ netlify.toml
- ✅ .gitignore

### Functions 文件
- ✅ netlify/functions/db.js
- ✅ netlify/functions/init-db.js
- ✅ netlify/functions/auth-login.js
- ✅ netlify/functions/auth-register.js
- ✅ netlify/functions/students-id.js
- ✅ netlify/functions/courses-id.js
- ✅ netlify/functions/teachers-id.js
- ✅ netlify/functions/_shared/auth.js
- ✅ netlify/functions/_shared/http.js
- ✅ netlify/functions/_shared/validators.js

**总计**: 18 个关键文件

---

## 结语

本操作清单详细记录了从零开始构建、配置、部署学生信息管理系统的完整流程。按照此清单操作，可完整复现整个项目。

**开发时间线：**
1. 需求分析与技术选型
2. 前端 UI 开发（HTML/CSS/JS）
3. 数据库设计（4张表）
4. Netlify Functions 开发（10个函数）
5. 本地测试与调试
6. Netlify 部署配置
7. 生产环境初始化
8. 功能测试与问题修复
9. 文档整理

**核心技术要点：**
- ✅ 纯静态前端 + Serverless 架构
- ✅ JWT 无状态认证
- ✅ PostgreSQL 关系型数据库
- ✅ bcrypt 密码加密
- ✅ UTF-8 中文支持
- ✅ 移动端响应式设计
- ✅ RESTful API 设计
- ✅ 事务保证数据一致性

---

**最后更新**: 2025-11-09  
**版本**: v1.0  
**状态**: 生产环境运行中 ✅

